
{% extends "base.html" %}

{% block title %}وضعیت پردازش - GeoSphereAI{% endblock %}

{% block content %}

<div class="container">
    <h1>پردازش در حال انجام</h1>
    <p>لطفاً صبور باشید. سیستم در حال پردازش فایل شما است. این فرآیند ممکن است چند دقیقه طول بکشد.</p>
    
    <!-- Status Container -->
    <div class="status-container">
        <div class="status-item">
            <span class="status-label">وضعیت فعلی:</span>
            <span class="status-value" id="status-text">در حال برقراری ارتباط با سرور...</span>
        </div>
        <div class="status-item">
            <span class="status-label">پیشرفت:</span>
            <span class="status-value" id="progress-text">0%</span>
        </div>
        <div class="status-item">
            <span class="status-label">نام فایل:</span>
            <span class="status-value" id="filename-text">{{ filename if filename else 'نامشخص' }}</span>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
        <div class="progress-percentage" id="progress-percentage">0%</div>
    </div>
    
    <!-- Processing Details -->
    <div class="processing-details">
        <h3>جزئیات پردازش</h3>
        <div class="processing-log" id="processing-log">
            <div class="log-entry">در حال آماده‌سازی برای شروع پردازش...</div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn btn-secondary" id="refresh-btn">🔄 بروزرسانی</button>
        <button type="button" class="btn btn-danger" id="cancel-btn" style="display: none;">❌ لغو پردازش</button>
    </div>
    
    <!-- Navigation Links -->
    <div class="navigation-links">
        <a href="{{ url_for('home') }}" class="back-link">← بازگشت به صفحه اصلی</a>
        <a href="{{ url_for('file_selection') }}" class="back-link">← پردازش فایل جدید</a>
    </div>
</div>

<style>
/* Processing Page Specific Styles */
.progress-container {
    margin: 2rem 0;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    width: 0%;
    transition: width 0.5s ease;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
    margin-top: 0.5rem;
}

.processing-details {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.processing-details h3 {
    margin-top: 0;
    color: #0056b3;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.processing-log {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 6px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

.log-entry {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
    border-bottom: 1px solid #e9ecef;
    color: #495057;
}

.log-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.log-entry.success {
    color: #28a745;
    font-weight: bold;
}

.log-entry.error {
    color: #dc3545;
    font-weight: bold;
}

.log-entry.info {
    color: #007bff;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

/* Status indicators */
.status-processing {
    color: #856404;
    animation: pulse 2s infinite;
}

.status-completed {
    color: #155724;
}

.status-failed {
    color: #721c24;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Loading animation */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .navigation-links {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .progress-percentage {
        font-size: 1.2rem;
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const processId = "{{ process_id }}";
    const statusText = document.getElementById('status-text');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const processingLog = document.getElementById('processing-log');
    const filenameText = document.getElementById('filename-text');
    const refreshBtn = document.getElementById('refresh-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    
    let updateInterval;
    let isCompleted = false;
    let isFailed = false;
    
    // Function to update progress
    function updateProgress() {
        if (isCompleted || isFailed) {
            clearInterval(updateInterval);
            return;
        }
        
        fetch(`/api/process-status/${processId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update status
                statusText.textContent = data.message || 'در حال پردازش...';
                statusText.className = `status-value status-${data.status}`;
                
                // Update progress
                const progress = data.progress || 0;
                progressText.textContent = `${progress}%`;
                progressBar.style.width = `${progress}%`;
                progressPercentage.textContent = `${progress}%`;
                
                // Update filename
                if (data.filename) {
                    filenameText.textContent = data.filename;
                }
                
                // Add log entry
                if (data.message && data.message !== statusText.dataset.lastMessage) {
                    addLogEntry(data.message, data.status);
                    statusText.dataset.lastMessage = data.message;
                }
                
                // Handle completion
                if (data.status === 'completed') {
                    isCompleted = true;
                    clearInterval(updateInterval);
                    addLogEntry('پردازش با موفقیت انجام شد!', 'success');
                    
                    // Show success message and redirect
                    setTimeout(() => {
                        window.location.href = `/results/${processId}`;
                    }, 3000);
                }
                
                // Handle failure
                if (data.status === 'failed') {
                    isFailed = true;
                    clearInterval(updateInterval);
                    addLogEntry(`پردازش ناموفق: ${data.message}`, 'error');
                    
                    // Show retry options
                    setTimeout(() => {
                        if (confirm('پردازش ناموفق بود. آیا می‌خواهید دوباره تلاش کنید؟')) {
                            window.location.href = '/file-selection';
                        }
                    }, 2000);
                }
                
                // Show cancel button for long processes
                if (progress > 10 && progress < 90 && data.status === 'processing') {
                    cancelBtn.style.display = 'inline-block';
                }
                
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
                addLogEntry(`خطا در دریافت وضعیت: ${error.message}`, 'error');
                
                // Retry after delay
                setTimeout(() => {
                    if (!isCompleted && !isFailed) {
                        updateProgress();
                    }
                }, 5000);
            });
    }
    
    // Function to add log entry
    function addLogEntry(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `${new Date().toLocaleTimeString('fa-IR')}: ${message}`;
        
        processingLog.appendChild(logEntry);
        processingLog.scrollTop = processingLog.scrollHeight;
        
        // Keep only last 50 entries
        const entries = processingLog.querySelectorAll('.log-entry');
        if (entries.length > 50) {
            entries[0].remove();
        }
    }
    
    // Manual refresh
    refreshBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '🔄 در حال بروزرسانی...';
        
        updateProgress();
        
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '🔄 بروزرسانی';
        }, 2000);
    });
    
    // Cancel process
    cancelBtn.addEventListener('click', function() {
        if (confirm('آیا از لغو پردازش اطمینان دارید؟')) {
            fetch(`/api/cancel-process/${processId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry('پردازش لغو شد', 'info');
                    clearInterval(updateInterval);
                    setTimeout(() => {
                        window.location.href = '/file-selection';
                    }, 2000);
                } else {
                    addLogEntry('خطا در لغو پردازش', 'error');
                }
            })
            .catch(error => {
                console.error('Error cancelling process:', error);
                addLogEntry(`خطا در لغو پردازش: ${error.message}`, 'error');
            });
        }
    });
    
    // Start monitoring
    addLogEntry('شروع نظارت بر پردازش...', 'info');
    updateProgress();
    updateInterval = setInterval(updateProgress, 2000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
    
    // Handle visibility change (pause/resume when tab is hidden/shown)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        } else {
            if (!isCompleted && !isFailed) {
                updateProgress();
                updateInterval = setInterval(updateProgress, 2000);
            }
        }
    });
});
</script>
{% endblock %}
